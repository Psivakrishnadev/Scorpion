
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>NeuralNetAnalysis &#8212; Scorpion 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for NeuralNetAnalysis</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The module contains modules that enable prediction of indian stock market based on news analysis of the company.</span>
<span class="sd">This modules follows Neural Network approach, hence training and prediction takes time.</span>
<span class="sd">A single company can take upto 40 mins on CPU and around 5 to 10 mins based on the NVIDIA GPU.</span>
<span class="sd">The prediction in stored in the form of graphs that contains both real values and the predicted values.</span>
<span class="sd">If using theano</span>
<span class="sd">    *Run the file with THEANO_FLAGS=device=cuda python using the terminal for GPU.</span>
<span class="sd">    *Run the file with THEANO_FLAGS=device=cpu python using the terminal for CPU.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">quandl</span>
<span class="kn">from</span> <span class="nn">keras.layers.core</span> <span class="k">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span>
<span class="kn">from</span> <span class="nn">keras.layers.recurrent</span> <span class="k">import</span> <span class="n">LSTM</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">model_from_json</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">preprocessing</span>



<span class="n">quandl</span><span class="o">.</span><span class="n">ApiConfig</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="s1">&#39;tHhnk2LX1KrKyxKKyhaz&#39;</span>
<span class="n">seq_len</span> <span class="o">=</span> <span class="mi">21</span>
<span class="n">days</span> <span class="o">=</span> <span class="mi">365</span>
<span class="n">s_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">seq_len</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">neurons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">decay</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">75</span>


<div class="viewcode-block" id="get_stock_data"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.get_stock_data">[docs]</a><span class="k">def</span> <span class="nf">get_stock_data</span><span class="p">(</span><span class="n">stock_code</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ma</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method takes BSE stock code, normalize bollean and a list for mooving averages.</span>
<span class="sd">    Collects stock information from Quandl using an API call.</span>
<span class="sd">    Removes unnecessary information and normalises the required data for training and testing.</span>

<span class="sd">    :type stock_code: String</span>
<span class="sd">    :param stock_code: Stock code of comapny in BSE</span>
<span class="sd">    :type normalize: Boolean</span>
<span class="sd">    :param normalize: normalise the values or not</span>
<span class="sd">    :type ma: list</span>
<span class="sd">    :param ma: List of moving averages</span>
<span class="sd">    :return df: DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">quandl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BSE/BOM&#39;</span> <span class="o">+</span> <span class="n">stock_code</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;WAP&#39;</span><span class="p">,</span> <span class="s1">&#39;No. of Trades&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Turnover&#39;</span><span class="p">,</span> <span class="s1">&#39;Deliverable Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;% Deli. Qty to Traded Qty&#39;</span><span class="p">,</span> <span class="s1">&#39;Spread H-L&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Spread C-O&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Renaming all the columns so that we can use the old version code</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;No. of Shares&#39;</span><span class="p">:</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">:</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Percentage change</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Moving Average</span>
    <span class="k">if</span> <span class="n">ma</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="k">for</span> <span class="n">moving</span> <span class="ow">in</span> <span class="n">ma</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">ma&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moving</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">moving</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">min_max_scaler</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Open</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">High</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Low</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Volume</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ma</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">for</span> <span class="n">moving</span> <span class="ow">in</span> <span class="n">ma</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">ma&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moving</span><span class="p">)]</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">ma&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moving</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="c1"># Move Adj Close to the rightmost for the ease of training</span>
    <span class="n">adj_close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">adj_close</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">df</span>


<div class="viewcode-block" id="plot_stock"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.plot_stock">[docs]</a><span class="k">def</span> <span class="nf">plot_stock</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method used for visual aids for evaluation of Closing rates and percentage chage of a particular company during</span>
<span class="sd">    a fixed interval.</span>

<span class="sd">    :type df: pandas.DataFrame</span>
<span class="sd">    :param df: DataFrame</span>
<span class="sd">    :return None:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Pct&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Percentage change&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span></div>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="load_data"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.load_data">[docs]</a><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">stock</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Methods takes in a dataframe and prepare the data for training and testing purposes.</span>
<span class="sd">    For maximum efficiency we are using 99% data for training and the rest for testing.</span>

<span class="sd">    :type stock: pandas.DataFrame</span>
<span class="sd">    :param stock: dataframe containing stock data</span>
<span class="sd">    :type seq_len: int</span>
<span class="sd">    :param seq_len: Number of days for training</span>
<span class="sd">    :return [X_train, y_train, X_test, y_test]: List</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">amount_of_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stock</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Amount of features = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">amount_of_features</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">stock</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
    <span class="n">sequence_length</span> <span class="o">=</span> <span class="n">seq_len</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># index starting from 0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">sequence_length</span><span class="p">):</span>  <span class="c1"># maxmimum date = lastest date - sequence length</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="n">sequence_length</span><span class="p">])</span>  <span class="c1"># index : index + 22days</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 80% split</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Amount of training data = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Amount of testing data = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">train</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="p">:]</span>  <span class="c1"># 90% date</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># all data until day m</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># day m + 1 adjusted close price</span>

    <span class="n">X_test</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="n">days</span><span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="n">days</span><span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">amount_of_features</span><span class="p">))</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">amount_of_features</span><span class="p">))</span>
</div>
    <span class="k">return</span> <span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]</span>


<div class="viewcode-block" id="build_model"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.build_model">[docs]</a><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">neurons</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">decay</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Methods creates a models based on fine tuned shapes and fuctions to produce the best result for prediction.</span>
<span class="sd">    The Model uses</span>
<span class="sd">        *2 LSTM layers</span>
<span class="sd">        *2 Dense layers</span>

<span class="sd">    :type shape: list</span>
<span class="sd">    :param shape: Shape of the data matrix</span>
<span class="sd">    :type neurons: list</span>
<span class="sd">    :param neurons: List of neurons</span>
<span class="sd">    :type dropout: float</span>
<span class="sd">    :param dropout: Dropuot to prevent overfitting</span>
<span class="sd">    :type decay: float</span>
<span class="sd">    :param decay: Decay rate</span>
<span class="sd">    :return model: keras.models.Sequential</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">neurons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">neurons</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>
    <span class="c1"># model = load_model(&#39;my_LSTM_stock_model1000.h5&#39;)</span>
    <span class="n">adam</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">decay</span><span class="o">=</span><span class="n">decay</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span></div>
    <span class="k">return</span> <span class="n">model</span>


<div class="viewcode-block" id="model_score"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.model_score">[docs]</a><span class="k">def</span> <span class="nf">model_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Methods calulates the training and testing score based on the MSE(Mean Square Error).</span>

<span class="sd">    :type model: keras.models.Sequential</span>
<span class="sd">    :param model: Model for training</span>
<span class="sd">    :type X_train: numpy.array</span>
<span class="sd">    :param X_train: Traning Data</span>
<span class="sd">    :type y_train: numpy.array</span>
<span class="sd">    :param y_train: Training Results</span>
<span class="sd">    :type X_test: numpy.array</span>
<span class="sd">    :param X_test: Testing Data</span>
<span class="sd">    :type y_test: numpy.array</span>
<span class="sd">    :param y_test: Testing Results</span>
<span class="sd">    :return trainScore, TestScore: Float, Float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trainScore</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Train Score: </span><span class="si">%.5f</span><span class="s1"> MSE (</span><span class="si">%.2f</span><span class="s1"> RMSE)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trainScore</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">trainScore</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="n">testScore</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test Score: </span><span class="si">%.5f</span><span class="s1"> MSE (</span><span class="si">%.2f</span><span class="s1"> RMSE)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testScore</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">testScore</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span></div>
    <span class="k">return</span> <span class="n">trainScore</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">testScore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="percentage_difference"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.percentage_difference">[docs]</a><span class="k">def</span> <span class="nf">percentage_difference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method predicts the stock values and calculates the percent difference of the prediction Vs real values.</span>

<span class="sd">    :type model: keras.models.Sequential</span>
<span class="sd">    :param model: Model for training</span>
<span class="sd">    :param X_test: Training Result</span>
<span class="sd">    :type X_test: numpy.array</span>
<span class="sd">    :param y_test: Testing Result</span>
<span class="sd">    :type y_test: numpy.array</span>
<span class="sd">    :return p: Predicted Values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">percentage_diff</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)):</span>  <span class="c1"># for each data index in test data</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># pr = prediction on day u</span>

        <span class="n">percentage_diff</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pr</span> <span class="o">-</span> <span class="n">y_test</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">/</span> <span class="n">pr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="n">p</span>


<div class="viewcode-block" id="denormalize"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.denormalize">[docs]</a><span class="k">def</span> <span class="nf">denormalize</span><span class="p">(</span><span class="n">stock_code</span><span class="p">,</span> <span class="n">normalized_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method denormalises the previousy normalised value for again ploting in the graph.</span>

<span class="sd">    :type stock_code: str</span>
<span class="sd">    :param stock_code: Stock code of comapny in BSE</span>
<span class="sd">    :type normalized_value: numpy.array</span>
<span class="sd">    :param normalized_value: Normalised data</span>
<span class="sd">    :return new: numpy.array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">quandl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BSE/BOM&#39;</span> <span class="o">+</span> <span class="n">stock_code</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;WAP&#39;</span><span class="p">,</span> <span class="s1">&#39;No. of Trades&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Turnover&#39;</span><span class="p">,</span> <span class="s1">&#39;Deliverable Quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;% Deli. Qty to Traded Qty&#39;</span><span class="p">,</span> <span class="s1">&#39;Spread H-L&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Spread C-O&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Renaming all the columns so that we can use the old version code</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;No. of Shares&#39;</span><span class="p">:</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">:</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">normalized_value</span> <span class="o">=</span> <span class="n">normalized_value</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># return df.shape, p.shape</span>
    <span class="n">min_max_scaler</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">MinMaxScaler</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">min_max_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">normalized_value</span><span class="p">)</span>
</div>
    <span class="k">return</span> <span class="n">new</span>


<div class="viewcode-block" id="plot_result"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.plot_result">[docs]</a><span class="k">def</span> <span class="nf">plot_result</span><span class="p">(</span><span class="n">stock_name</span><span class="p">,</span> <span class="n">normalized_value_p</span><span class="p">,</span> <span class="n">normalized_value_y_test</span><span class="p">,</span> <span class="n">s_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method saves the result in the form of a picture after adjusting the predicted values on the basis of the result</span>
<span class="sd">    of news analysis done on the comapny.</span>

<span class="sd">    :type stock_name: str</span>
<span class="sd">    :param stock_name: Stock code of comapny in BSE</span>
<span class="sd">    :type normalized_value_p: numpy.array</span>
<span class="sd">    :param normalized_value_p: Normalised Predicted values</span>
<span class="sd">    :type normalized_value_y_test: Normalised Test values</span>
<span class="sd">    :param normalized_value_y_test: numpy.array</span>
<span class="sd">    :type s_name: str</span>
<span class="sd">    :param s_name: Name of the comapany</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataBase</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;Sting.db&#39;</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">dataBase</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">newp</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">stock_name</span><span class="p">,</span> <span class="n">normalized_value_p</span><span class="p">)</span>
    <span class="n">newy_test</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">stock_name</span><span class="p">,</span> <span class="n">normalized_value_y_test</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT EVALUATION FROM Company_News WHERE NAME IS &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_name</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Prob</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT </span><span class="si">{}</span><span class="s2"> FROM Company_News&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Prob</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">Prob</span> <span class="o">=</span> <span class="s2">&quot;Positive&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">Prob</span> <span class="o">==</span> <span class="s1">&#39;Positive&#39;</span><span class="p">:</span>
        <span class="n">newp</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="mi">20</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newp</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">newp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">newy_test</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;The test result for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stock_name</span><span class="p">))</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Adjusted Close&#39;</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">Graphs</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">s_name</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1080</span><span class="p">)</span></div>
    <span class="n">plt2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="StockPrediction"><a class="viewcode-back" href="../NeuralNetAnalysis.html#NeuralNetAnalysis.StockPrediction">[docs]</a><span class="k">def</span> <span class="nf">StockPrediction</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Driver program for the entire Moduele</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataBase</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;Sting.db&#39;</span><span class="p">)</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">dataBase</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT A.Name, A.BSE , B.Frequency FROM StockCode AS A LEFT JOIN Companies AS B WHERE A.Name = B.Name ORDER BY B.Frequency DESC;&quot;</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>

        <span class="n">stock_code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">get_stock_data</span><span class="p">(</span><span class="n">stock_code</span><span class="p">,</span> <span class="n">ma</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>

        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">neurons</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">decay</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/Models/&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stock_code</span><span class="p">)):</span>
            <span class="c1"># load json and create model</span>
            <span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stock_code</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">loaded_model_json</span> <span class="o">=</span> <span class="n">json_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">json_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_from_json</span><span class="p">(</span><span class="n">loaded_model_json</span><span class="p">)</span>
            <span class="c1"># load weights into new model</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stock_code</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded model from disk&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model Found!!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Saving</span>
            <span class="c1"># serialize model to JSON</span>
            <span class="n">model_json</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/Models/&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stock_code</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">json_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">model_json</span><span class="p">)</span>
            <span class="c1"># serialize weights to HDF5</span>
            <span class="n">model</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.h5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stock_code</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved model to disk&quot;</span><span class="p">)</span>

        <span class="n">model_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">percentage_difference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

        <span class="n">plot_result</span><span class="p">(</span><span class="n">stock_code</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>
        <span class="n">dataBase</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Mohit Khare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>